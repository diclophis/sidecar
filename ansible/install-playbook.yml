---
- hosts: sidecar
  vars_files:
    - vars/sidecar.yml
  tasks:
    - name: set hostname
      become: true
      hostname: name={{ sidecar_hostname }}

    - name: install sources.list
      become: true
      copy: src=files/xenial-sources.list dest=/etc/apt/sources.list

    - name: copy google packages gpg key
      copy: src=packages.google.com.apt-key.gpg dest=/var/tmp/packages.google.com.apt-key.gpg

    - name: install google packages gpg key
      become: true
      apt_key: state=present file=/var/tmp/packages.google.com.apt-key.gpg

    - name: install kubeadm apt sources
      become: true
      apt_repository: repo="deb http://packages.cloud.google.com/apt kubernetes-xenial main" state=present

    - name: update and safe upgrade apt-get packages
      become: true
      apt: update_cache=true cache_valid_time=60 upgrade=safe

    - name: install main system packages
      apt: pkg={{ item }} state=present
      become: true
      with_items:
        - unattended-upgrades
        - apt-transport-https
        - build-essential
        - git
        - screen
        - vim
        - psmisc
        - curl
        - zip
        - rsync
        - wget
        - htop
        - tree
        - mailutils
        - console-setup
        - kbd
        - xkb-data
        - man-db
        - libc-bin
        - dnsutils
        - pv
        - libssl1.0.0
        - openssl
        - libssl-dev
        - update-manager-core
        - update-notifier-common
        - libpcap0.8
        - tcpdump
        - aptitude
        - python-setuptools
        - libc6-dev
        - g++
        - zlib1g-dev
        - python-pkg-resources
        - iftop
        - nethogs
        - gcc
        - make
        - autoconf
        - autogen
        - automake
        - pkg-config
        - libcgmanager-dev
        - libcgmanager0
        - libcgroup-dev
        - libcgroup1
        - libpam-cgfs
        - nodejs
        - npm
        - ca-certificates
        - aufs-tools
        - docker.io
        - kubelet
        - kubeadm
        - kubectl
        - kubernetes-cni
        - ruby
        - ruby-dev
        - ruby-bundler

    - name: add {{ ansible_ssh_user }} to docker group, to build docker images for
      become: true
      user: name={{ ansible_ssh_user }} append=true groups=docker

    - name: reset kubeadm
      become: true
      shell: kubeadm reset

#    - name: init kubeadm
#      become: true
#      shell: kubeadm init
#
#    - name: install kubectl config
#      become: true
#      copy: remote_src=true src=/etc/kubernetes/admin.conf dest=/home/{{ ansible_ssh_user }}/ owner={{ ansible_ssh_user }} group={{ ansible_ssh_user }}
#    
#    # https://github.com/kubernetes/kubernetes/issues/43815#issuecomment-291573635
#    # https://www.weave.works/docs/net/latest/kube-addon/#install
#    - name: install network
#      become: true
#      shell: kubectl apply -f https://git.io/weave-kube-1.6
#
#    # https://kubernetes.io/docs/getting-started-guides/kubeadm/#master-isolation
#    - name: allow scheduling on master node
#      become: true
#      shell: kubectl taint nodes --all node-role.kubernetes.io/master-
